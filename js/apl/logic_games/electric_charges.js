// Game propriety
const MIN_WIDTH = 4;
const MAX_WIDTH = 8;
const DEFAULT_INP_VALUE = '';
const DEFAULT_OUT_VALUE = 9;

// Request body
// ?Change spaces in nines, so that DEFAULT_INP_VALUE = '';
const state = 'c-p;~2V7G}9LMiH1O*YOg3`u@L_h>_0SZRZs3?kYff5I30%%l}M;KwaDvsLisCLj=x3;y~VYS=6_uh5yy|?yv<Q~F<kU(wU=kw*CyL<P)cXz+L`yVIfRUyTnO3d=rmDQ<TvZ_Q;!Bd&p{oRY#7ya4yBBeer*ptT6E~1~_#p_EO<p`N%t}n^2V$Od~O3%-=ke_2AKifinI>{u%X}`q$FtW*<FOXrxL<W*H3-wC(XB5Xt;x84g=t)Ll|LrC9QqYo~q?H_>!txUN1%5@Z()I@7`_qcFS?Oi@By)M`?dT=*<jm}ywz>#vYqE3@XInol`L`4ER~7f;Rfp+REPqk@`=Vc0$@@j#b12KNon49d`O^G465HA*Hug&_7dvKYKCQLKS<$ntdQGua$2RJ;#5%L0w;U_$+lSei=IJCPtuy{~1EWA5m<=|A+f<zxmfD;lRb@;|Ps&KjOfn^9C1oR>Y{*dQ9JRi_IyZG@pto19zD=ge$oF#8#`q}1B9u{8WA!d^&RWlOzM9rE*I-h4Wf-zlI%8<A-p&|GNWM(q)k;o7$P~HI&m}e{-9R`Q5uCLiIvxI)^lqq~rFTUuo*rsft&<4}Qw^sqL$-<|w`77_tU79Ja8w+p@vu`zj#cRbl#wxdXRXqkXgIP<E*MgkDn3BQagH)U$7$j-^ywUVCKn=oLv*I>EPX<rDbYa40(+r|-U{{QXSQsVNK%e|n1HwQf;SW_IWO^jHBl7Zk42sFlKtP-$CCammzP~X#Y(wRQf^J3#EQO%6<u1>xuwU_IV#RW`yRxtU_G;RL^;QuFMe!WeH<k^satq%7jGGB1s@|5IBf#2<vC3vA<g7P1Sje%h*WrAE>*W;c>_iLQqL9Xc~;Tq-})`@yc+-Gd3BYHV@%<^8cWWr5%Wq0$pmGBH>XYX(FFzZt&|1RtPhR!i}VeP@QCt8n%DX&IBZHS<U%^9@voCC5kZl0XiLhD+iX3@Y}Jvqc;i*+qP%{~s|(?O)<us(T?i$0A;^T_V2*TyQL1?-8PS9pBdGww<$_ul$7?;I5T!0CEXYo)h*Ib|O>~Beo`q6XygXN;t;DMph^NYo&n(3o*5dkCrI(8OwWJ$2W@|YVkHZW5?_sw2^=D7aAMX%uY5c6kjjrxx=R1+I=STX!rF=Up{k50$SL#R9v9)n?koXbzjq#!%cT&8=OtZ9~)qsMHwF7HI#x&N<n~-EU^TluaDY-~zf&uJKlK>KF+yw?Q{UQ7!gTW9m6kr>LMo2+?l*0CaRCY$BvDk>NjZ9zySuD=TVetyb`m+=?q`uI8W7sC_JPrmSpeg-cfUuQ>f#z)d=V0#UvzU4=P1AlNuMOMB+p##LJ?H=;K}XODL;)IkW6_f?peu{QyR*F|nw>p80sR+2EYJda{qF<%vbm)5{0yuBV`v%ruo`v^SPM1+x}dgztzaA24t9W@U>Dc}_JVzM{=s2z1RMp&+1YajTm?7T&EOsw0TwIFH;1|CcPQFkgx_=vS_jsH4Rp@D%{PkO-~c!Tj)4>4Bsc|5gR|fqI1es>i{KKt46cA{;5xVgZh?NF5oitnaj<IGmQ*wNmT;;Y*jBJQ*m}SZG(eh0L=V70T9;}S`5CA?8o#F~37H1ck=_b%22efYw-cz0_dKaDdQ*ZO2mC<*)d83XMxv|*2&6hhoiq>)I)hFi9L&Ib17Mp2C7oZ`u5>+sp+JxF1aJpscfoz|5YVjx#YE2H&1Jw7-{=OMfjekP7Zj)sd_V{Y1Uyiq=n;4fo`C+~DIFi`7tWW%s^~gFBP-cWa2@g|<0Genc;x#dFP@#lv%o?y9r^u1qW8=DrFcIt+!yKxs`|w_ROTFcd%G%!A6MFT@KCt(k!rs_T=w;vMGe1b+$1PCq-nFzu;w>c&zduD@r5>R+eNhR5ZSR)RA)_>uHCx#h>q#mD^}aPPv88RkFK~~d#!p6caNI2JYRo9R{Kr4mqJ;`+sC)AUp@bT5vxWm9q{B%>sBqFzSZF9jsCaC>Jt+4#*I%JIB}3+@Q|U&!`>dABBW0G_8r`6-_3aM{SQ7geKdK>)M+12pON*+r=Mkip0jsf?*4BMT)cGoYJ6tZk@vp8|ATtPcfVX;xZsaJ=kMM#d+u+)Z*DPq<zIJyUhXtz>!vTi+PGoI`t7<0&$qmouxn?dwd;Od;(E*F*{Sn?A3t&I^qF&KPyQtC$FA}c+a*<4W9j}rfiK_r`48Ps@E8';
const size = 5282;
const hash = '{^ZA7QaCulfvh8g4iEUpNI*xqQL|v`7v*`{kY(6Boe91?%u|hxj&Rx}|G6<X0N~7P49Y6_8R>bI49r$h';

function getInputMatrix() {
  return Array.from(document.querySelectorAll('.input__table tr')).map(
    item => Array.from(item.querySelectorAll('input')).map(
      x => ("0" === x.value) ? 0 : +x.value || 9)
  )
}

document.querySelector('.btns__solve').addEventListener('click', async () => {
  let input = getInputMatrix();

  let solution = await evaluateAPL(`solver (↑⍣≡0∘⎕JSON) '${JSON.stringify(input)}'`);
  if (solution.length) {
    let matrix = solution.map(item => item
      .split` `
      .filter(x => x !== "")
      .map(x => x.replace('¯', '-'))
    )

    for (i in matrix) {
      for (j in matrix[i]) {
        if (matrix[i][j] === "0") matrix[i][j] = input[i][j];
      }
    }

    session_style(2);
    makeOutputTable(matrix);
  }
});

document.querySelector('.btns__create').addEventListener('click', async () => {
  alert("I can't create this puzzle yet, but you can try to solve this");
  session_style(1);
  let matrix = [[3, '', -1, ''], ['', '', '', ''], [0, '', '', 0], [-2, '', 0, '']]
  let input_table = document.querySelector('.input__table');
  input_table.innerHTML = '';

  const table = document.createElement('table');
  const tbody = document.createElement('tbody');
  table.appendChild(tbody);
  input_table.appendChild(table);

  const width = matrix[0].length;
  for (i = 0; i < width; ++i) {
    let row = document.createElement('tr');
    for (j = 0; j < width; ++j) {
      let input = document.createElement('input');
      input.type = 'number';
      input.value = matrix[i][j];
      row.appendChild(input);
    }
    tbody.appendChild(row);
  };
});

document.querySelector('.btns__try').addEventListener('click', async () => {
  let matrix = getInputMatrix();

  let solution = (await evaluateAPL(`solver (↑⍣≡0∘⎕JSON) '${JSON.stringify(matrix)}'`))
    .map(item => item
      .split` `
      .filter(x => x !== "")
      .map(x => +x.replace('¯', '-'))
    )

  if (solution.length) {
    session_style(3);
    matrix.map(x => +x)
    let try_label = document.querySelector('.try__label');
    try_label.innerText = 'Solve';
    try_label.style.color = '#4169e1';
    // !makeTryTable(matrix)

    let try_table = document.querySelector('.try__table');
    try_table.innerHTML = '';

    const table = document.createElement('table');
    const tbody = document.createElement('tbody');
    table.appendChild(tbody);
    try_table.appendChild(table);

    const width = solution[0].length;
    for (i = 0; i < width; ++i) {
      let row = document.createElement('tr');
      for (j = 0; j < width; ++j) {
        let input = document.createElement('input');
        input.type = 'number';
        if (matrix[i][j] !== 9) {
          input.placeholder = matrix[i][j];
          input.readOnly = 'true';
        } else input.onclick = 'this.select()';
        if (1) input.style.userSelect = 'none';
        row.appendChild(input);
      }
      tbody.appendChild(row);
    }
  }
});

document.querySelector('.btns__verify').addEventListener('click', async () => {
  // TODO: Make cells not equal to 9, unselectable
  // TODO: User can input +-

  let matrix = getInputMatrix();

  let try_matrix = Array.from(document.querySelectorAll('.try__table tr')).map(
    item => Array.from(item.querySelectorAll('.try__table input')).map(
      x => ("0" === x.value) ? 0 : +x.value || 0
    ))

  let solution = (await evaluateAPL(`solver (↑⍣≡0∘⎕JSON) '${JSON.stringify(matrix)}'`))
    .map(item => item
      .split` `
      .filter(x => x !== "")
      .map(x => +x.replace('¯', '-'))
    )

  let try_label = document.querySelector('.try__label');

  if ((JSON.stringify(solution) === JSON.stringify(try_matrix))) {
    try_label.innerText = 'Correct!';
    try_label.style.color = '#008000';
    document.querySelectorAll('.try__table input').forEach(elem => elem.readOnly = 'true');
  } else {
    try_label.innerText = 'Wrong!';
    try_label.style.color = '#e62020';
  }

  document.querySelectorAll('.try__table input').forEach((e) => {
    e.addEventListener('click', () => {
      try_label.innerText = 'Try again!';
      try_label.style.color = '#4169e1';
    })
  })
});