<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Presenze UFO</title>

    <link rel="stylesheet" href="style.css" />
    <script defer src="script.js"></script>
    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>
  </head>

  <body>
    <div class="background-container">
      <img src="/test/img/moon2.png" />
      <div class="stars"></div>
      <div class="twinkling"></div>
      <div class="clouds"></div>
    </div>

    <div class="contact-box">
      <h2>Presenze UFO:</h2>
      <script>
        document.querySelector('.contact-box h2').innerText +=
          ' ' +
          new Date().toLocaleDateString('it-IT', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
          });
      </script>

      <div
        id="g_id_onload"
        data-client_id="585871178834-6ccf5b0dcukd6grao01d4fsbgcee0oj2.apps.googleusercontent.com"
        data-context="signin"
        data-ux_mode="popup"
        data-callback="handleCredentialResponse"></div>

      <div class="g-signin2" style="display: none">
        <div
          class="g_id_signin"
          data-type="standard"
          data-shape="pill"
          data-theme="outline"
          data-text="continue_with"
          data-size="large"
          data-logo_alignment="left"></div>
      </div>

      <form id="form" method="POST">
        <input
          type="email"
          name="email"
          id="email"
          placeholder="Email"
          maxlength="32"
          pattern="\S+.*"
          required />

        <input name="name" placeholder="Nome" id="name" maxlength="32" pattern="\S+.*" required />
        <input
          type="text"
          name="surname"
          id="surname"
          placeholder="Cognome"
          maxlength="32"
          pattern="\S+.*"
          required />

        <select id="activity" name="activity">
          <option value="Studio" selected>Studio</option>
          <option value="Accademia del profondo">Accademia del profondo</option>
          <option value="Argonauti">Argonauti</option>
          <option value="Officina dell'inutile">Officina dell'inutile</option>
          <option value="Sonora">Sonora</option>
          <option value="UFO Social Team">UFO Social Team</option>
        </select>

        <button type="submit">Invia</button>
      </form>
    </div>

    <div class="thanks-box" style="display: none">
      <h1>BENVENUTO A UFO!</h1>
    </div>
<script>
const capitalize = word => word.toLowerCase().replace(/\b[a-z](?=[a-z]{2})/g, c => c.toUpperCase());

window.addEventListener('load', () => {
  console.log('Test log');
  gapi.load('client:auth2', initClient);
  console.log('Client loaded :' + client);
});

function handleCredentialResponse(response) {
  document.querySelector('.g-signin2').style.display = 'none';
  const responsePayload = JSON.parse(atob(response.credential.split`.`[1]));

  gapi.client.sheets.spreadsheets.values
    .get({
      spreadsheetId: '1_Eh8OUx9bTaYxgYN7l0x49z7lc8VekoMeDQ1uhgLyqk',
      range: 'Elenco!B3:D',
    })
    .then(res => {
      console.log('Accessed Spreadsheets data.');
      return JSON.parse(res.body)['values'];
    })
    .then(values => {
      const email = responsePayload.email;
      document.querySelector('#email').value = email;
      localStorage.setItem('email', email);

      const value = values.filter(row => row[0] === email)[0];

      if (value) {
        document.querySelector('#name').value = value[1];
        document.querySelector('#surname').value = value[2];

        document.querySelector('.thanks-box h1').innerText = 'BENTORNATO A UFO';
      } else {
        document.querySelector('#name').value = responsePayload.given_name;
        document.querySelector('#surname').value = responsePayload.family_name;
      }
    })
    .catch(error => console.error(error));
}

const initClient = () => {
  gapi.client
    .init({
      apiKey: 'AIzaSyDKx7AMwVu65LAGW-Ar9C9kOZ8os7Vw5us',
      clientId: '585871178834-6ccf5b0dcukd6grao01d4fsbgcee0oj2.apps.googleusercontent.com',
      discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
      scope: 'https://www.googleapis.com/auth/spreadsheets',
    })
    .then(
      () => {
        console.log('Gapi client inizialized.');
        gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

        updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
      },
      error => console.error(JSON.stringify(error, null, 2))
    );
};

const updateSigninStatus = isSignedIn => {
  if (isSignedIn) {
    document.querySelector('#form').addEventListener('submit', async e => {
      e.preventDefault();
      console.log('Checking if authenticating...');
      console.log(gapi.auth2.getAuthInstance().isSignedIn.get());
      if (gapi.auth2.getAuthInstance().isSignedIn.get()) {
        addToRecord();
        console.log('Added Spreadsheets Row');

        document.querySelector('.contact-box').style.display = 'none';
        document.querySelector('.thanks-box').style.display = 'flex';
      }
    });
  } else document.querySelector('.g-signin2').style.display = 'flex';
};

const addToRecord = () => {
  console.log('Adding data...');
  console.table([
            new Date().toLocaleDateString('en-UK', {
              day: '2-digit',
              month: 'long',
              year: 'numeric',
            }),
            document.querySelector('#email').value,
            capitalize(document.querySelector('#name').value),
            capitalize(document.querySelector('#surname').value),
            document.querySelector('#activity').value,
          ];
  gapi.client.sheets.spreadsheets.values
    .append(
      {
        spreadsheetId: '1_Eh8OUx9bTaYxgYN7l0x49z7lc8VekoMeDQ1uhgLyqk',
        range: 'Presenze!B2:E2',
        valueInputOption: 'USER_ENTERED',
        insertDataOption: 'INSERT_ROWS',
      },
      {
        range: 'Presenze!B2:E2',
        majorDimension: 'ROWS',
        values: [
          [
            new Date().toLocaleDateString('en-UK', {
              day: '2-digit',
              month: 'long',
              year: 'numeric',
            }),
            document.querySelector('#email').value,
            capitalize(document.querySelector('#name').value),
            capitalize(document.querySelector('#surname').value),
            document.querySelector('#activity').value,
          ],
        ],
      }
    )
    .then(response => console.log(response.result.updates))
    .catch(error => console.error(error));
};
</script>
  </body>
</html>
